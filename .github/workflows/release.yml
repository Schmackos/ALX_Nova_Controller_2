name: Release Firmware

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: get_version
        run: |
          CURRENT_VERSION=$(grep -oP '#define FIRMWARE_VERSION "\K[0-9]+\.[0-9]+\.[0-9]+' src/config.h)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          case "${{ github.event.inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update version in config.h
        run: |
          sed -i 's/#define FIRMWARE_VERSION ".*"/#define FIRMWARE_VERSION "${{ steps.new_version.outputs.new_version }}"/' src/config.h
          echo "Updated config.h:"
          grep FIRMWARE_VERSION src/config.h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build firmware
        run: platformio run

      - name: Calculate SHA256 checksum
        id: checksum
        run: |
          CHECKSUM=$(sha256sum .pio/build/esp32-s3-devkitm-1/firmware.bin | cut -d' ' -f1)
          echo "sha256=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "SHA256: $CHECKSUM"

      - name: Get firmware file size
        id: filesize
        run: |
          SIZE=$(stat -c%s .pio/build/esp32-s3-devkitm-1/firmware.bin)
          SIZE_KB=$((SIZE / 1024))
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_kb=$SIZE_KB" >> $GITHUB_OUTPUT
          echo "Firmware size: $SIZE bytes ($SIZE_KB KB)"

      - name: Prepare release notes
        run: |
          # Use the prepared RELEASE_NOTES.md
          cp RELEASE_NOTES.md release_notes.md
          
          # Optional: Replace version placeholder if we used one (we hardcoded it, but this is safe)
          sed -i "s/X.X.X/${{ steps.new_version.outputs.new_version }}/g" release_notes.md
          
          # Append firmware details
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Firmware Details" >> release_notes.md
          echo "**Version:** ${{ steps.new_version.outputs.new_version }}" >> release_notes.md
          echo "**SHA256:** ${{ steps.checksum.outputs.sha256 }}" >> release_notes.md
          echo "**File Size:** ${{ steps.filesize.outputs.size }} bytes (${{ steps.filesize.outputs.size_kb }} KB)" >> release_notes.md
          echo "**Build Date:** $(date -u +%Y-%m-%d)" >> release_notes.md
          echo "**Platform:** ESP32-S3" >> release_notes.md
          
          echo "Release notes prepared:"
          cat release_notes.md

      - name: Commit version change
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/config.h
          git commit -m "Bump version to ${{ steps.new_version.outputs.new_version }}"
          git push

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.new_version.outputs.new_version }}
          name: Version ${{ steps.new_version.outputs.new_version }}
          body_path: release_notes.md
          files: .pio/build/esp32-s3-devkitm-1/firmware.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
